let study_years = [
    {
        name: "fst_year_fst_term_subjects",
        study_year_id: 1,
        term_id: 1,
        added: false,
        subjects: [
            {
                safwa_name: "العقيدة",
                form_url: "https://docs.google.com/forms/d/1Gqqtw34JkaODRZHXKGmW_untLYWq8-lhU8_hM62PapA/edit"
            },
            {
                safwa_name: "الآداب الإسلامية",
                form_url: "https://docs.google.com/forms/d/1VSzLQMM4GC6PmANU67K7gWpzjxtfCIQEP6Gk01xvisU/edit"
            },
            {
                safwa_name: "الفقه",
                form_url: "https://docs.google.com/forms/d/1M9SCkKJ9SkKHDz_Nu5pU_33A-UA3S_r5nfAiZWWht5o/edit"
            },
            {
                safwa_name: "أصول الفقه",
                form_url: "https://docs.google.com/forms/d/1CQyRvqhOKSdvcAhoLghpfk-k47stJwn__FAD9cdGFEo/edit"
            },
            {
                safwa_name: "الحديث",
                form_url: "https://docs.google.com/forms/d/1NbvuZnFH_469v6z6lgsIiM713pA8ExLUAn9dQUPdZaU/edit"
            },
            {
                safwa_name: "النحو",
                form_url: "https://docs.google.com/forms/d/17S1Od3Dm7Peb22VeEk5_f3GaMN7gWkO9b7DMGrSjszI/edit"
            },
            {
                safwa_name: "التجويد",
                form_url: "https://docs.google.com/forms/d/1um5rdWounA-_hOBIGcpZbRFSR6xV-BKDoeslwt5ycG4/edit"
            },
            {
                safwa_name: "مصطلح الحديث",
                form_url: "https://docs.google.com/forms/d/11Eu-JOWmLaPgS_1Du_bMSG5nrnEyF7_Kp41auGeY-Jc/edit"
            }
        ]
    },
    {
        name: "snd_year_fst_term_subjects",
        study_year_id: 2,
        term_id: 1,
        added: false,
        subjects: [
            {
                safwa_name: "التربية والسلوك",
                form_url: "https://docs.google.com/forms/d/1Er6wrc-AU4RiT0odFv5uOIN81bmTHsM92GbVurzG-EA/edit"
            },
            {
                safwa_name: "العقيدة",
                form_url: "https://docs.google.com/forms/d/1bACRIB8CVn4FgoOhIaD5rfZDgbOY4w9VljPE6rCED9M/edit"
            },
            {
                safwa_name: "تاريخ التشريع",
                form_url: "https://docs.google.com/forms/d/1llKx8WpCgLnt86JetB8AsxwayUZJB_8vWJyoPhTIqYE/edit"
            },
            {
                safwa_name: "الفقه المالكي",
                form_url: "https://docs.google.com/forms/d/1X3IuaGl36bD2UfmTE5ZWqMyaxrn7xZwomIuymUqQNvE/edit"
            },
            {
                safwa_name: "الفقه الشافعي",
                form_url: "https://docs.google.com/forms/d/1kV28rYlc6--yqHAcg0HvttSdrlA9hjJ-XBzrVM5BZMs/edit"
            },
            {
                safwa_name: "الفقه الحنبلي",
                form_url: "https://docs.google.com/forms/d/1qe5Wb-6m7RPExjLZ5MGDT_xquUkvXbSaZwDdJ-FN7go/edit"
            },
            {
                safwa_name: "الفقه الحنفي",
                form_url: "https://docs.google.com/forms/d/1cRDcyhvTTiwomIFZRkhaFITs23p0wIMynI7Y510KUBY/edit"
            },
            {
                safwa_name: "التفسير",
                form_url: "https://docs.google.com/forms/d/1eSFoghZN8ny4wMfKy7ot_gQY5vpHHJ-3Mx8s7HTexMs/edit"
            },
            {
                safwa_name: "البلاغة",
                form_url: "https://docs.google.com/forms/d/1c5x3Ywdj7Uwl_xqWZfgZeahxZ7FrGoZUFwx1rUgkzZY/edit"
            },
            {
                safwa_name: "السيرة",
                form_url: "https://docs.google.com/forms/d/1caqVW4y3EDc1solbYVpbuM6n0zAzml5HI-ykaDaJ5kY/edit"
            },
            {
                safwa_name: "علوم القرآن",
                form_url: "https://docs.google.com/forms/d/1z11EaYsGleWZhzMHGvx5P1RpOh0b7yRcAX7TGcGe7-Q/edit"
            },
        ]
    },
    {
        name: "trd_year_fst_term_subjects",
        study_year_id: 3,
        term_id: 1,
        added: false,
        subjects: [
            {
                safwa_name: "التربية والسلوك",
                form_url: "https://docs.google.com/forms/d/1lUrILYwD9ausG5fCihHuo7edn3hN6uhAJ65fgM5mnrI/edit"
            },
            {
                safwa_name: "العقيدة",
                form_url: "https://docs.google.com/forms/d/1O-ekna5hu5gDV0ggUxrSHBzTX0H8L4wXEpRm_rKy9uE/edit"
            },
            {
                safwa_name: "الفقه العام",
                form_url: "https://docs.google.com/forms/d/1asOLPedzF4bb8gbZoJAh52V25eN8gCuixcQ73fDXY_Y/edit"
            },
            {
                safwa_name: "الفقه الشافعي",
                form_url: "https://docs.google.com/forms/d/1TND62NkyjrmSUG8wsuM659f9H8gf_AuK_bue1w-hLg4/edit"
            },
            {
                safwa_name: "الفقه المالكي",
                form_url: "https://docs.google.com/forms/d/1Tq62bNR9T1m7o5ccyBoO1jROrJIH51PFaoLAxvXMFgw/edit"
            },
            {
                safwa_name: "الفقه الحنبلي",
                form_url: "https://docs.google.com/forms/d/1l-9o6Sy9HBo3D_0mEwaxMTchBwWePwxd9ogYJes6jiQ/edit"
            },
            {
                safwa_name: "الفقه الحنفي",
                form_url: "https://docs.google.com/forms/d/1Fv0a2OlwAW8jZ_dZkbRq6kCcF9bqDVLGEoOoO_qZ7o4/edit"
            },
            {
                safwa_name: "مصطلح الحديث",
                form_url: "https://docs.google.com/forms/d/1x67gF8Q2eSMaPDNfvy1bu4oKXvzOSu_yqSjkY5XTgTo/edit"
            },
            {
                safwa_name: "القواعد الفقهية",
                form_url: "https://docs.google.com/forms/d/1qG1EIonyqWquPx8rAlome_yuwWunx-q0FN7q0TmSsH8/edit"
            },
            {
                safwa_name: "التفسير",
                form_url: "https://docs.google.com/forms/d/1jdc9cNsliJvteK43UwW3hrD-BDeBaZLWmRWWm-2qNmE/edit"
            },
            {
                safwa_name: "التجويد",
                form_url: "https://docs.google.com/forms/d/1MXFuDj14iDgNmmK_g-WBZ7Mw2ImmTST41hOE_Vy0Qq8/edit"
            },
            {
                safwa_name: "أصول الفقه",
                form_url: "https://docs.google.com/forms/d/1svqfJCoQZek3RSU32A2t9jyVyTxZ3BUsrWwi5i72CNg/edit"
            },
            {
                safwa_name: "الفرق والمذاهب",
                form_url: "https://docs.google.com/forms/d/1Q6N0yy66nugZv1jF_NfOBqtp7QUZJuDra_dElcBsMUc/edit"
            },
            {
                safwa_name: "التاريخ",
                form_url: "https://docs.google.com/forms/d/1tTINjSMd_Rc0vpwR_d5jQZICjoto8Xlx58k6l-dungo/edit"
            },
            {
                safwa_name: "اللغة العربية",
                form_url: "https://docs.google.com/forms/d/1agul-yKRQNv5lWi43CXrfOg0H_5r1RNDiIgTYKWypnY/edit"
            },
        ]
    },
    {
        name: "fth_year_fst_term_subjects",
        study_year_id: 4,
        term_id: 1,
        added: false,
        subjects: [
            // {
            //     safwa_name: "التربية والسلوك",
            //     form_url: "https://docs.google.com/forms/d/15tO312wAD-mOzWKGoibor_QLe0Pymv5_CCJ_aJrk-5Y/edit" },
            {
                safwa_name: "العقيدة",
                form_url: "https://docs.google.com/forms/d/1NGkLEHZhsgzKReJVlhe2JHHAuMK6gZOx6mm3cqKyBfg/edit"
            },
            {
                safwa_name: "المحرر في الحديث (1)",
                form_url: "https://docs.google.com/forms/d/1L2sLPnjkIsNFsqL6cXumMpsDXk3DX2n9vegEyFQpSIo/edit"
            },
            {
                safwa_name: "المحرر في الحديث (2)",
                form_url: "https://docs.google.com/forms/d/1TdfA2QJp8pPtEPBhFzDPGLXrKkgaNLIPm00Zot7BtqY/edit"
            },
            {
                safwa_name: "القضايا المعاصرة (1)",
                form_url: "https://docs.google.com/forms/d/1fcv8WPJR_GOcZMyFhrU2UL1WLYgryk32rRWpxAZY3ew/edit"
            },
            {
                safwa_name: "القضايا المعاصرة (2)",
                form_url: "https://docs.google.com/forms/d/14H_KRfMRBmQjNtS3Sc5BUjf4ZUloTFEUtNmCYXFQz9Q/edit"
            },
            {
                safwa_name: "الأدب العربي",
                form_url: "https://docs.google.com/forms/d/1Fzpcf4mfnZPR-AtuTAPf7NeIlcdRqPMM8Vh9SlsMDjI/edit"
            },
            {
                safwa_name: "الشبهات الفكرية",
                form_url: "https://docs.google.com/forms/d/1M1jbT1lhR_vW90wzna0ktesICrIUFkPAC-_IXoOYx1Q/edit"
            },
            {
                safwa_name: "التاريخ",
                form_url: "https://docs.google.com/forms/d/1BKhXTH79q2bClUeixgvP4cLrsOrKaV3y-VWBFGd2lts/edit"
            },
            {
                safwa_name: "مهارات البحث",
                form_url: "https://docs.google.com/forms/d/1Y2Xzn3rGp_KuiDFIrNR7Xk7oWWzK54ZzB7w85HW7KqA/edit"
            },
            {
                safwa_name: "المعاجم",
                form_url: "https://docs.google.com/forms/d/1Nyb6Ki0ldlOdPnVsEnT9PFkWy01JjQe3AnQwN0HWYZk/edit"
            }
        ]
    },]

let sheet = SpreadsheetApp.openById('1pudIQM8NJph3wsQuPq6kbKgT-a0Ef9czbXSm4n-atHE').getSheets()[0]
// variables for putting the questions and answers in the right position
let question_row = 1
let right_answer_index = 17

// main function to run
function main() {
    extractForms()
}

function extractForms() {
    insertHeader()
    study_years.forEach(study_year => {
        Logger.log(study_year.name)
        study_year.subjects.forEach(subject => {
            extractFormQuestions(study_year, subject)
        })
        Logger.log("Done")
    })
}


//insert header
function insertHeader() {
    let column = 1
    //title
    sheet.getRange(question_row, column++).setValue("title")
    //points
    sheet.getRange(question_row, column++).setValue("points")
    //lesson or subject
    sheet.getRange(question_row, column++).setValue("lesson or subject")
    //path
    sheet.getRange(question_row, column++).setValue("path")
    //term
    sheet.getRange(question_row, column++).setValue("term")
    //subject
    sheet.getRange(question_row, column++).setValue("subject")
    //lesson
    sheet.getRange(question_row, column++).setValue("lesson")
    //question type
    sheet.getRange(question_row, column++).setValue("type")
    //description
    sheet.getRange(question_row, column++).setValue("description")
    //choices count
    sheet.getRange(question_row, column++).setValue("choices count")
    //coices
    sheet.getRange(question_row, column++).setValue("select_1")
    sheet.getRange(question_row, column++).setValue("select_2")
    sheet.getRange(question_row, column++).setValue("select_3")
    sheet.getRange(question_row, column++).setValue("select_4")
    sheet.getRange(question_row, column++).setValue("select_5")
    sheet.getRange(question_row, column++).setValue("select_6")
    //right answer
    sheet.getRange(question_row, column++).setValue("answer")
    question_row++
}


// Iterate over all questions
function extractFormQuestions(studyYearSubjects, subject) {
    let form = FormApp.openById(getFormId(subject.form_url))
    //create new spreadsheet with form name
    let ssNewUrl = SpreadsheetApp.create(form.getTitle()).getUrl()
    var sheet = SpreadsheetApp.openByUrl(ssNewUrl).getSheets()[0]

    form.getItems().forEach((item) => {
        switch (item.getType()) {
            case FormApp.ItemType.MULTIPLE_CHOICE:
                insertMul(studyYearSubjects, subject, item.asMultipleChoiceItem())
                break
            case FormApp.ItemType.CHECKBOX:
                insertCheckBoxQuestion(studyYearSubjects, subject, item.asCheckboxItem())
                break
        }
    })
    Logger.log(subject.safwa_name)
}

function addRowBasicInfo(column, studyYearSubjects, subject, title, points) {
    //title
    sheet.getRange(question_row, column++).setValue(title)
    //points
    sheet.getRange(question_row, column++).setValue(points)
    //lesson or subject
    sheet.getRange(question_row, column++).setValue("subject")
    //path
    sheet.getRange(question_row, column++).setValue(studyYearSubjects.study_year_id)
    //term
    sheet.getRange(question_row, column++).setValue(studyYearSubjects.term_id)
    //subject
    sheet.getRange(question_row, column++).setValue(subject.safwa_name)
    //lesson
    sheet.getRange(question_row, column++).setValue("")
    return column;
}

function insertMul(studyYearSubjects, subject, question) {
    let column = 1
    let type = 1
    let points = question.getPoints()
    if (points === 0) {
        return
    }

    let title = question.getTitle()

    {
        if (title === "المذهب" ||
            title === "تأكدت من كتابة البريد الإلكتروني صحيحًا" ||
            title === "تأكدت من كتابة الاسم كاملًا كما هو في الأوراق الرسمية باللغة العربية" ||
            title === "تأكدت من كتابة الرقم الجامعي كما هو في الأوراق الرسمية" ||
            title === "دخولك الاختبار أكثر من مرة يعرضك لخسارة جميع علاماتك" ||
            title === "أتعهد بعدم فتح الكتاب أو أي مصدر آخر أثناء الاختبار، وعدم نشر أو مناقشة أسئلة الاختبار إلا بعد انتهاء الوقت المحدد  والله على ما أقول  شهيد." ||
            title === "النوع"
        ) {
            return
        }
    }

    title = formatQuestionTitle(title)
    let choices = question.getChoices()

    column = addRowBasicInfo(column, studyYearSubjects, subject, title, points);

    if (choices.length === 2) {
        if ((choices[0].getValue().includes("صح") && choices[1].getValue().replace(/أ/, "ا").includes("خطا")) ||
            (choices[0].getValue().replace(/أ/, "ا").includes("خطا") && choices[1].getValue().includes("صح")) ||
            (choices[1].getValue().includes("صواب") && choices[0].getValue().replace(/أ/, "ا").includes("خطا").includes("خطا")) ||
            (choices[0].getValue().replace(/أ/, "ا").includes("خطا") && choices[1].getValue().includes("صواب"))) {
            type = 2
            //question type
            sheet.getRange(question_row, column++).setValue(type)
            //description
            sheet.getRange(question_row, column++).setValue("")
            //choices count
            sheet.getRange(question_row, column++).setValue("")
            addBinaryChoice(choices);
            return
        }
    }


    //question type
    sheet.getRange(question_row, column++).setValue(type)
    //description
    sheet.getRange(question_row, column++).setValue("")
    //choices count
    sheet.getRange(question_row, column++).setValue(choices.length)
    addMultipleChoices(column, choices);
    question_row++
}

function insertCheckBoxQuestion(sheet, studyYearSubjects, subject, question) {
    let coloumn = 1
    let title = formatQuestionTitle(question.getTitle())
    let points = question.getPoints()
    if (points === 0) {
        return
    }

    let type = 4
    let choices = question.getChoices()

    coloumn = addRowBasicInfo(coloumn, studyYearSubjects, subject, title, points);
    //question type
    sheet.getRange(question_row, coloumn++).setValue(type)
    //description
    sheet.getRange(question_row, coloumn++).setValue("")
    //choices count
    sheet.getRange(question_row, coloumn++).setValue(choices.length)

    addCheckBoxChoice(sheet, coloumn, choices);

    question_row++
}

function addBinaryChoice(choices) {
    choices.forEach(function (choice) {
        if (choice.isCorrectAnswer()) {
            if (choice.getValue().includes("صح") || choice.getValue().includes("صواب")) {
                sheet.getRange(question_row, right_answer_index).setValue(1)
            } else {
                sheet.getRange(question_row, right_answer_index).setValue(0)
            }
        }
    })
    question_row++
}

function formatChoice(choice) {
    let choiceValue = choice.getValue().replace(/‏/, "").trim()
    if (choiceValue.startsWith("-")) {
        choiceValue = choiceValue.substring(1).trim()
    }
    if (choiceValue.startsWith("--")) {
        choiceValue = choiceValue.substring(2).trim()
    }
    if (choiceValue.startsWith("_")) {
        choiceValue = choiceValue.substring(1).trim()
    }
    return choiceValue;
}

function addCheckBoxChoice(sheet, coloumn, choices) {
    choices.forEach(function (choice, index) {
        let choiceValue = formatChoice(choice);
        sheet.getRange(question_row, coloumn++).setValue(choiceValue)
        if (choice.isCorrectAnswer()) {
            let correct_answers = sheet.getRange(question_row, right_answer_index).getValue()
            sheet.getRange(question_row, right_answer_index).setValue(correct_answers + (index + 1) + ",")
        }
    })
    let correct_answers = sheet.getRange(question_row, right_answer_index).getValue()
    if (correct_answers.endsWith(",")) {
        sheet.getRange(question_row, right_answer_index).setValue(correct_answers.substring(0, correct_answers.length - 1))
    }
}

function addMultipleChoices(column, choices) {
    choices.forEach(function (choice, index) {
        let choiceValue = formatChoice(choice);
        sheet.getRange(question_row, column++).setValue(choiceValue)
        if (choice.isCorrectAnswer()) {
            sheet.getRange(question_row, right_answer_index).setValue(index + 1)
        }
    })
}

function formatQuestionTitle(title) {
    return title.replace(/\(\d+\)-|\(\d+\) -|\(\d+\)|\d+ -|\d+-|\d+/, '').trim()
}

function getFormId(formUrl) {
    return formUrl.split("/")[5]
}




